<!DOCTYPE html>
<meta charset="utf-8">
<style>
  body,
  html {
    height: 100%;
    width: 100%;
  }

  .node {
    stroke-width: 1.5px;
  }

  .node text {
    font-size: 10px;
  }

  .link {
    stroke: #000;
    stroke-width: 1px;
  }

  #graph {
    position: fixed !important;
  }

  .white {
    width: 100%;
    height: 90%;
    box-sizing: border-box;
  }

  .panel {
    height: 600px;
    overflow: auto;
  }

  .trailers iframe {
    margin-right: 10px;
  }

  #poster {
    max-width: 100%;
  }
</style>
<html>

<head>
  <title>Proyecto Y</title>
  <link rel="stylesheet" href="http://neo4j-contrib.github.io/developer-resources/language-guides/assets/css/main.css">
  <script src="js/d3.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
  <script src="js/angular.min.js"></script>
</head>

<body ng-app="proyecto-y" ng-controller="mainController as main">
  <div id="graph">
  </div>
  <div role="navigation" class="navbar navbar-default navbar-static-top">
    <div class="container">
      <div class="row">
        <!-- <div class="col-sm-6 col-md-6">
          <ul class="nav navbar-nav">
            <li>
              <form role="search" class="navbar-form" id="search">
                <div class="form-group">
                  <input type="text" value="Matrix" placeholder="Search for Movie Title" class="form-control" name="search">
                </div>
                <button class="btn btn-default" type="submit">Search</button>
              </form>
            </li>
          </ul>
        </div> -->
        <div class="navbar-header col-sm-6 col-md-6">
          <div class="logo-well">
            <a href="#">
              <img src="https://www.ycombinator.com/images/ycombinator-logo-fb889e2e.png" alt=":v" id="logo">
            </a>
          </div>
          <div class="navbar-brand">
            <div class="brand">Proyecto Y</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="panel panel-default">
        <div class="panel-heading">Search Results</div>
        <table id="results" class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Movie</th>
              <th>Released</th>
              <th>Tagline</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="pelicula in resultados" ng-click="update(pelicula)">
              <td>{{pelicula.nombre}}</td>
              <td>{{pelicula.anio}}</td>
              <td>{{pelicula.genero}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="col-md-8">
      <div class="panel panel-default" ng-show="peliculaActiva">
        <div class="panel-heading" id="title">Detalle <span class="pull-right" id="close" ng-click="cleanActive()">X</span></div>
        <div class="row">
          <div class="col-sm-2 col-md-2">
            <img src="" ng-src="{{peliculaActiva.imagen}}" ng-show="peliculaActiva.imagen" class="well" id="poster" />
          </div>
          <div class="col-md-10 col-sm-10">
            <h4>{{peliculaActiva.nombre}}</h4>
            <ul id="crew">
              <li>{{peliculaActiva.anio}}</li>
              <li>{{peliculaActiva.director}}</li>
              <li>{{peliculaActiva.protagonista}}</li>
              <li>{{peliculaActiva.comprar}}</li>
              <li>{{peliculaActiva.rating}}</li>
            </ul>
            <a ng-href="{{peliculaActiva.comprar}}" class="pull-right" ng-show="peliculaActiva.comprar"><img src="img/amazon.gif" width="120px" height="42px" /></a>
            <div class="trailers">
              <iframe width="220" height="115" ng-src="{{trailer}}" frameborder="0" ng-repeat="trailer in peliculaActiva.trailers track by $index" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="white"></div>
  <script>
    var graph = {
      "nodes": [{"nombre":"Batman the Animated Series: Vol. 3","anio":"1993","genero":"Animated","director":"Bruce Timm","protagonista":"Kevin Conroy","comprar":"http://www.amazon.com/Batman-Animated-Series-Classic-Collection/dp/B0007XG43W","imagen":"","trailers":[],"id":11,"rating":0}, {"nombre":"Batman: Mask of the Phantasm","anio":"1993","genero":"Animated","director":"Bruce W. Timm","protagonista":"Kevin Conroy","comprar":"http://www.amazon.com/Batman-Mask-Phantasm-Kevin-Conroy/dp/B0000399WH","imagen":"http://ecx.images-amazon.com/images/I/51E2Kw8U6cL._SY445_.jpg","trailers":["https://www.youtube.com/embed/Gcq3psi6_Ns"],"id":17,"rating":0}, {"nombre":"Batman: The Animated Series: Out of the Shadows","anio":"1992","genero":"Animated","director":"Jr. Efrem Zimbalist","protagonista":"Kevin Conroy","comprar":"http://www.amazon.com/Batman-The-Animated-Series-Shadows/dp/B000096IBL","imagen":"http://ecx.images-amazon.com/images/I/81J6hBnT5mL._SX342_.jpg","trailers":[],"id":19,"rating":0}, {"nombre":"Batman & Mr. Freeze: Subzero","anio":"1998","genero":"Animated","director":"Boyd Kirkland","protagonista":"Kevin Conroy","comprar":"http://www.amazon.com/Batman-Mr-Freeze-Kevin-Conroy/dp/B00005Y71E","imagen":"http://ecx.images-amazon.com/images/I/51KQ465S0ZL._SY445_.jpg","trailers":["https://www.youtube.com/embed/u7yHdSyCqxE"],"id":22,"rating":0}, {"nombre":"Batman the Animated Series: Vol. 1","anio":"1992","genero":"Animated","director":"Bruce Timm","protagonista":"Kevin Conroy","comprar":"http://www.amazon.com/Batman-Animated-Series-Classic-Collection/dp/B00023E894","imagen":"http://ecx.images-amazon.com/images/I/711wpfzaphL._SX342_.jpg","trailers":["https://www.youtube.com/embed/Ng6BpY2oDhw"],"id":24,"rating":0}, {"nombre":"Adventures of Batman & Robin: The Joker/Fire & Ice","anio":"1992","genero":"Animated","director":"Loren Lester","protagonista":"Kevin Conroy","comprar":"http://www.amazon.com/The-Adventures-Batman-Robin-Animated/dp/B00016XOB0","imagen":"http://ecx.images-amazon.com/images/I/51QES2X4F2L._SX342_.jpg","trailers":[],"id":28,"rating":0}, {"nombre":"Batman: Mystery of the Batwoman","anio":"2003","genero":"Animated","director":"Curt Geda ","protagonista":"Kevin Conroy","comprar":"http://www.amazon.com/Batman-Mystery-Batwoman-Kevin-Conroy/dp/B0000AQS7M","imagen":"http://ecx.images-amazon.com/images/I/518ZHKPGDFL._SY445_.jpg","trailers":["https://www.youtube.com/embed/Qe9evYaBZ9M"],"id":29,"rating":0}, {"nombre":"Batman: The Animated Series: The Legend Begins","anio":"1992","genero":"Animated","director":"Loren Lester","protagonista":"Kevin Conroy","comprar":"http://www.amazon.com/Batman-Animated-Series-Legend-Begins/dp/B00005Y71J","imagen":"http://ecx.images-amazon.com/images/I/51DKXX77BNL._SY445_.jpg","trailers":[],"id":30,"rating":0}, {"nombre":"Batman the Animated Series: Vol. 2","anio":"1992","genero":"Animated","director":"Bruce Timm","protagonista":"Kevin Conroy","comprar":"http://www.amazon.com/Batman-Animated-Series-Classic-Collection/dp/B0002ZMHWM","imagen":"http://ecx.images-amazon.com/images/I/710yyAd98AL._SY445_.jpg","trailers":["https://www.youtube.com/embed/GdKvE9xER7U"],"id":35,"rating":0}]
,
      "links": [{"type":"PROTAGONISTA", "source":11, "target":17}, {"type":"PROTAGONISTA", "source":11, "target":19}, {"type":"PROTAGONISTA", "source":11, "target":22}, {"type":"PROTAGONISTA", "source":11, "target":24}, {"type":"DIRECTOR", "source":11, "target":24}, {"type":"PROTAGONISTA", "source":11, "target":28}, {"type":"PROTAGONISTA", "source":11, "target":29}, {"type":"PROTAGONISTA", "source":11, "target":30}, {"type":"PROTAGONISTA", "source":11, "target":35}, {"type":"DIRECTOR", "source":11, "target":35}, {"type":"PROTAGONISTA", "source":17, "target":11}, {"type":"PROTAGONISTA", "source":17, "target":19}, {"type":"PROTAGONISTA", "source":17, "target":22}, {"type":"PROTAGONISTA", "source":17, "target":24}, {"type":"PROTAGONISTA", "source":17, "target":28}, {"type":"PROTAGONISTA", "source":17, "target":29}, {"type":"PROTAGONISTA", "source":17, "target":30}, {"type":"PROTAGONISTA", "source":17, "target":35}, {"type":"PROTAGONISTA", "source":19, "target":11}, {"type":"PROTAGONISTA", "source":19, "target":17}, {"type":"PROTAGONISTA", "source":19, "target":22}, {"type":"PROTAGONISTA", "source":19, "target":24}, {"type":"PROTAGONISTA", "source":19, "target":28}, {"type":"PROTAGONISTA", "source":19, "target":29}, {"type":"PROTAGONISTA", "source":19, "target":30}, {"type":"PROTAGONISTA", "source":19, "target":35}, {"type":"PROTAGONISTA", "source":22, "target":11}, {"type":"PROTAGONISTA", "source":22, "target":17}, {"type":"PROTAGONISTA", "source":22, "target":19}, {"type":"PROTAGONISTA", "source":22, "target":24}, {"type":"PROTAGONISTA", "source":22, "target":28}, {"type":"PROTAGONISTA", "source":22, "target":29}, {"type":"PROTAGONISTA", "source":22, "target":30}, {"type":"PROTAGONISTA", "source":22, "target":35}, {"type":"PROTAGONISTA", "source":24, "target":11}, {"type":"DIRECTOR", "source":24, "target":11}, {"type":"PROTAGONISTA", "source":24, "target":17}, {"type":"PROTAGONISTA", "source":24, "target":19}, {"type":"PROTAGONISTA", "source":24, "target":22}, {"type":"PROTAGONISTA", "source":24, "target":28}, {"type":"PROTAGONISTA", "source":24, "target":29}, {"type":"PROTAGONISTA", "source":24, "target":30}, {"type":"PROTAGONISTA", "source":24, "target":35}, {"type":"DIRECTOR", "source":24, "target":35}, {"type":"PROTAGONISTA", "source":28, "target":11}, {"type":"PROTAGONISTA", "source":28, "target":17}, {"type":"PROTAGONISTA", "source":28, "target":19}, {"type":"PROTAGONISTA", "source":28, "target":22}, {"type":"PROTAGONISTA", "source":28, "target":24}, {"type":"PROTAGONISTA", "source":28, "target":29}, {"type":"PROTAGONISTA", "source":28, "target":30}, {"type":"DIRECTOR", "source":28, "target":30}, {"type":"PROTAGONISTA", "source":28, "target":35}, {"type":"PROTAGONISTA", "source":29, "target":11}, {"type":"PROTAGONISTA", "source":29, "target":17}, {"type":"PROTAGONISTA", "source":29, "target":19}, {"type":"PROTAGONISTA", "source":29, "target":22}, {"type":"PROTAGONISTA", "source":29, "target":24}, {"type":"PROTAGONISTA", "source":29, "target":28}, {"type":"PROTAGONISTA", "source":29, "target":30}, {"type":"PROTAGONISTA", "source":29, "target":35}, {"type":"PROTAGONISTA", "source":30, "target":11}, {"type":"PROTAGONISTA", "source":30, "target":17}, {"type":"PROTAGONISTA", "source":30, "target":19}, {"type":"PROTAGONISTA", "source":30, "target":22}, {"type":"PROTAGONISTA", "source":30, "target":24}, {"type":"PROTAGONISTA", "source":30, "target":28}, {"type":"DIRECTOR", "source":30, "target":28}, {"type":"PROTAGONISTA", "source":30, "target":29}, {"type":"PROTAGONISTA", "source":30, "target":35}, {"type":"PROTAGONISTA", "source":35, "target":11}, {"type":"DIRECTOR", "source":35, "target":11}, {"type":"PROTAGONISTA", "source":35, "target":17}, {"type":"PROTAGONISTA", "source":35, "target":19}, {"type":"PROTAGONISTA", "source":35, "target":22}, {"type":"PROTAGONISTA", "source":35, "target":24}, {"type":"DIRECTOR", "source":35, "target":24}, {"type":"PROTAGONISTA", "source":35, "target":28}, {"type":"PROTAGONISTA", "source":35, "target":29}, {"type":"PROTAGONISTA", "source":35, "target":30}]


    };
    var edges = [];
    graph.links.forEach(function(e) {
      var sourceNode = graph.nodes.filter(function(n) {
          return n.id === e.source;
        })[0],
        targetNode = graph.nodes.filter(function(n) {
          return n.id === e.target;
        })[0];
      edges.push({
        source: sourceNode,
        target: targetNode,
        value: e.type
      });
    });

    var force = d3.layout.force()
      .size([1000, 1000])
       .charge(200)
       .linkDistance(function(d) {
         if (d.type == "DIRECTOR")
           return 100;

         return 600;
     })
      .on("tick", tick);

    var drag = force.drag()
      .on("dragstart", dragstart)
      .on("dragend", dragended);

    var svg = d3.select("#graph").append("svg")
      .attr("width", "100%").attr("height", "100%")
      .attr("pointer-events", "all");

    var link = svg.selectAll(".link"),
      node = svg.selectAll(".node");


    var defs = svg.append("defs");
    var filter = defs.append("filter")
      .attr("id", "drop-shadow")
      .attr("height", "130%");

    // SourceAlpha refers to opacity of graphic that this filter will be applied to
    // convolve that with a Gaussian with standard deviation 3 and store result
    // in blur
    filter.append("feGaussianBlur")
      .attr("in", "SourceAlpha")
      .attr("stdDeviation", 5)
      .attr("result", "blur");

    // translate output of Gaussian blur to the right and downwards with 2px
    // store result in offsetBlur
    filter.append("feOffset")
      .attr("in", "blur")
      .attr("dx", 2)
      .attr("dy", 2)
      .attr("result", "offsetBlur");

    // overlay original SourceGraphic over translated blurred opacity by using
    // feMerge filter. Order of specifying inputs is important!
    var feMerge = filter.append("feMerge");

    feMerge.append("feMergeNode")
      .attr("in", "offsetBlur")
    feMerge.append("feMergeNode")
      .attr("in", "SourceGraphic");

    force
      .nodes(graph.nodes)
      .links(edges)
      .start();

    link = link.data(edges)
      .enter().append("line")
      .attr("class", "link")
      .style("stroke", function(d) {
        switch (d.value) {
          case "DIRECTOR":
            return "rgb(31, 157, 180)";
            break;
          case "PROTAGONISTA":
            return "rgb(189, 201, 41)";
            break;
          default:
            return "rgb(0, 0, 0)";
            break;
        }
      });


    node = node.data(graph.nodes)
      .enter().append("g")
      .attr("class", "node")
      .on("dblclick", dblclick)
      .attr("ng-click", function(d) {
        return "updateFromGraph(" + d.id + ")"
      })
      .call(drag);
    node.append("svg:rect")
      .attr("width", function(d) {
        return d.nombre.length * 5 + 60
      })
      .attr("x", "-20px")
      .attr("y", "-23px")
      .style("filter", "url(#drop-shadow)")
      .attr("height", "45px")
      .style("fill", "rgb(27, 172, 159)");

    node.append("svg:image")
      .attr("class", "circle")
      .attr("xlink:href", function(d) {
        return d.imagen
      })
      .attr("x", "-18px")
      .attr("y", "-18px")
      .attr("width", "36px")
      .attr("height", "36px");

    node.append("text")
      .attr("dx", 18)
      .attr("dy", ".25em")
      .style("fill", "rgb(247, 247, 247)")
      .text(function(d) {
        return d.nombre
      });

    function tick() {
      link.attr("x1", function(d) {
          console.log(d);
          return d.source.x;
        })
        .attr("y1", function(d) {
          return d.source.y;
        })
        .attr("x2", function(d) {
          return d.target.x;
        })
        .attr("y2", function(d) {
          return d.target.y;
        });


      node.attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")";
      });

    }

    resize();
    d3.select(window).on("resize", resize);

    function resize() {
      width = window.innerWidth, height = window.innerHeight;
      svg.attr("width", width).attr("height", height);
      force.size([width + 30, height]).resume();
    }

    function dblclick(d) {
      d3.select(this).classed("fixed", d.fixed = false);

    }

    function dragstart(d) {
      d3.select(this).classed("fixed", d.fixed = true);
    }

    function dragended(d) {
      $('#close').click();
    }
    var app = angular.module('proyecto-y', []).config(function($sceProvider) {
      $sceProvider.enabled(false);
    });

    app.controller('mainController', function($scope) {
      $scope.resultados = graph.nodes;
      $scope.update = function(pelicula) {
        $scope.peliculaActiva = pelicula;
        $("html, body").animate({
          scrollTop: "0px"
        });
      };
      $scope.updateFromGraph = function(id) {
        indexRes = $scope.resultados.map(function(pelicula) {
          return pelicula.id;
        }).indexOf(id);
        $scope.peliculaActiva = $scope.resultados[indexRes];
        $("html, body").animate({
          scrollTop: "0px"
        });
      }

      $scope.cleanActive = function() {
        $scope.peliculaActiva = null;
      }
    });
  </script>
</body>

</html>
