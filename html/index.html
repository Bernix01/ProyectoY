<!DOCTYPE html>
<meta charset="utf-8">
<style>
  body,
  html {
    height: 100%;
    width: 100%;
  }

  .node {
    stroke-width: 1.5px;
  }

  .node text {
    font-size: 10px;
  }

  .link {
    stroke: #000;
    stroke-width: 0.5px;
  }

  #graph {
    position: fixed !important;
  }

  .white {
    width: 100%;
    height: 90%;
    box-sizing: border-box;
  }

  .panel {
    height: 600px;
    overflow: auto;
  }

  .trailers iframe {
    margin-right: 10px;
  }

  #poster {
    max-width: 100%;
  }
</style>
<html>

<head>
  <title>Proyecto Y</title>
  <link rel="stylesheet" href="http://neo4j-contrib.github.io/developer-resources/language-guides/assets/css/main.css">
  <script src="js/d3.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
  <script src="js/angular.min.js"></script>
</head>

<body ng-app="proyecto-y" ng-controller="mainController as main">
  <div id="graph">
  </div>
  <div role="navigation" class="navbar navbar-default navbar-static-top">
    <div class="container">
      <div class="row">
        <!-- <div class="col-sm-6 col-md-6">
          <ul class="nav navbar-nav">
            <li>
              <form role="search" class="navbar-form" id="search">
                <div class="form-group">
                  <input type="text" value="Matrix" placeholder="Search for Pelicula Title" class="form-control" name="search">
                </div>
                <button class="btn btn-default" type="submit">Search</button>
              </form>
            </li>
          </ul>
        </div> -->
        <div class="navbar-header col-sm-6 col-md-6">
          <div class="logo-well">
            <a href="#">
              <img src="https://www.ycombinator.com/images/ycombinator-logo-fb889e2e.png" alt=":v" id="logo">
            </a>
          </div>
          <div class="navbar-brand">
            <div class="brand">Proyecto Y</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-4">
      <div class="panel panel-default">
        <div class="panel-heading">Resultados de busqueda <span class="pull-right" id="close" ng-click="showGraph()"><strong>X</strong></span></div>
        <table id="results" class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Pelicula</th>
              <th>Lanzamiento</th>
              <th>Vistas</th>
            </tr>
          </thead>
          <tbody>
            <tr ng-repeat="pelicula in resultados" ng-click="update(pelicula)">
              <td>{{pelicula.nombre}}</td>
              <td>{{pelicula.anio}}</td>
              <td>{{pelicula.rating}}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <div class="col-md-8">
      <div class="panel panel-default" ng-show="peliculaActiva">
        <div class="panel-heading" id="title">Detalle <span class="pull-right" id="close" ng-click="cleanActive()"><strong>X</strong></span></div>
        <div class="row">
          <div class="col-sm-3 col-md-3">
            <img src="" ng-src="{{peliculaActiva.imagen}}" ng-show="peliculaActiva.imagen" class="well" id="poster" />
          </div>
          <div class="col-md-9 col-sm-9">
            <h2>{{peliculaActiva.nombre}}</h2>
            <h3 class="pull-right">{{peliculaActiva.anio}}</h3>
            <ul id="crew">
              <li>{{peliculaActiva.director}}</li>
              <li>{{peliculaActiva.protagonista}}</li>
            </ul>
            <a ng-href="{{peliculaActiva.comprar}}" class="pull-right" ng-show="peliculaActiva.comprar"><img src="img/amazon.gif" width="120px" height="42px" /></a>
            <div class="trailers">
              <iframe width="270" height="215" ng-src="{{trailer}}" frameborder="0" ng-repeat="trailer in peliculaActiva.trailers track by $index" allowfullscreen></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="white"></div>
  <script>
    var graph = {
      "nodes": [{"nombre":"The Matrix: Reloaded","anio":"2003","genero":"Action","director":"Andy Wachowski","protagonista":"Keanu Reeves","comprar":"http://www.amazon.com/The-Matrix-Reloaded-Keanu-Reeves/dp/B001EC2J20","imagen":"http://ecx.images-amazon.com/images/I/51aB8lfW-QL._SX200_QL80_.jpg","trailers":["https://www.youtube.com/embed/kYzz0FSgpSU","https://www.youtube.com/embed/-URQ4sMzBvA"],"id":2,"rating":0,"color":"rgb(236, 173, 50)"}, {"nombre":"Sexual Matrix","anio":"1999","genero":"Erotic","director":"Udo Blass","protagonista":"Jay Stewart & Michelle Hall","comprar":"http://www.amazon.com/Sexual-Matrix-Jay-Stewart/dp/B000068MB0","imagen":"http://ecx.images-amazon.com/images/I/517EE89F5HL._SY445_.jpg","trailers":["https://www.youtube.com/embed/wbOW_JS1wUw"],"id":3,"rating":0,"color":"rgb(236, 173, 50)"}, {"nombre":"Armitage: Dual-Matrix","anio":"2002","genero":"Animation","director":"Katsuhito Akiyama","protagonista":"Ryôka Yuzuki","comprar":"http://www.amazon.com/Armitage-Dual-Matrix-Special-Edition/dp/B00006674V","imagen":"http://ecx.images-amazon.com/images/I/51C0M9Y6MHL._SY445_.jpg","trailers":["https://www.youtube.com/embed/I6NGqM3zmuc"],"id":4,"rating":0,"color":"rgb(236, 173, 50)"}, {"nombre":"The Matrix: Reloaded: Bonus Material","anio":"2003","genero":"Action","director":"Andy Wachowski","protagonista":"Keanu Reeves","comprar":"http://www.amazon.com/The-Matrix-Reloaded-Widescreen-Edition/dp/B0000AXE8I","imagen":"","trailers":["https://www.youtube.com/embed/kYzz0FSgpSU","https://www.youtube.com/embed/-URQ4sMzBvA"],"id":5,"rating":0,"color":"rgb(236, 173, 50)"}, {"nombre":"The Animatrix","anio":"2003","genero":"Animated","director":"Andrew R. Jones","protagonista":"Isshin Chiba","comprar":"http://www.amazon.com/The-Animatrix-Isshin-Chiba/dp/B00008LDPU","imagen":"","trailers":["https://www.youtube.com/embed/JwKJsRU6V_s","https://www.youtube.com/embed/DUCMqT3nN_c"],"id":6,"rating":0,"color":"rgb(236, 173, 50)"}, {"nombre":"The Matrix: Revolutions: Bonus Material","anio":"2003","genero":"Action","director":"Andy Wachowski","protagonista":"Keanu Reeves","comprar":"http://www.amazon.com/Matrix-Revolutions-Two-Disc-Widescreen-Edition/dp/B0001BKAEY","imagen":"","trailers":["https://www.youtube.com/embed/NhoaoTZJSX4"],"id":7,"rating":0,"color":"rgb(236, 173, 50)"}, {"nombre":"The Matrix","anio":"1999","genero":"Keanu Reeves","director":"","protagonista":"Andy Wachowski","comprar":"0","imagen":"https://www.youtube.com/embed/a94b1yZOBes","trailers":["http://www.amazon.com/The-Matrix-Keanu-Reeves/dp/B00000K19E"],"id":8,"rating":0,"color":"rgb(236, 173, 50)"}, {"nombre":"The Matrix: Revisited","anio":"2001","genero":"Special","director":"Josh Oreck","protagonista":"Lorenzo di Bonaventura","comprar":"http://www.amazon.com/The-Matrix-Revisited-Lorenzo-Bonaventura/dp/B00005OBB9","imagen":"http://ecx.images-amazon.com/images/I/5163QGY0J9L._SY445_.jpg","trailers":["https://www.youtube.com/embed/TJJ0Jes577I"],"id":9,"rating":0,"color":"rgb(236, 173, 50)"}, {"nombre":"Armitage III: Poly-Matrix","anio":"1996","genero":"Animated","director":"Takuya Satô","protagonista":"Elizabeth Berkley ","comprar":"http://www.amazon.com/Armitage-III-Poly-Matrix-Elizabeth-Berkley/dp/6304586477","imagen":"","trailers":["https://www.youtube.com/embed/iXKAsybyIRw","https://www.youtube.com/embed/nsYgaSGYuHc"],"id":10,"rating":0,"color":"rgb(236, 173, 50)"}, {"nombre":"The Matrix: Revolutions","anio":"2003","genero":"Action","director":"Andy Wachowski","protagonista":"Keanu Reeves","comprar":"http://www.amazon.com/The-Matrix-Revolutions-Keanu-Reeves/dp/B0014C0BMU","imagen":"http://ecx.images-amazon.com/images/I/51Q8oii-BoL._SX200_QL80_.jpg","trailers":["https://www.youtube.com/embed/NhoaoTZJSX4"],"id":1,"rating":0,"color":"rgb(179, 65, 49)"}],"links":[{"type":"PROTAGONISTA", "source":1, "target":2}, {"type":"DIRECTOR", "source":1, "target":2}, {"type":"PROTAGONISTA", "source":1, "target":5}, {"type":"DIRECTOR", "source":1, "target":5}, {"type":"PROTAGONISTA", "source":1, "target":7}, {"type":"DIRECTOR", "source":1, "target":7}, {"type":"PROTAGONISTA", "source":2, "target":1}, {"type":"DIRECTOR", "source":2, "target":1}, {"type":"PROTAGONISTA", "source":2, "target":5}, {"type":"DIRECTOR", "source":2, "target":5}, {"type":"PROTAGONISTA", "source":2, "target":7}, {"type":"DIRECTOR", "source":2, "target":7}, {"type":"PROTAGONISTA", "source":5, "target":1}, {"type":"DIRECTOR", "source":5, "target":1}, {"type":"PROTAGONISTA", "source":5, "target":2}, {"type":"DIRECTOR", "source":5, "target":2}, {"type":"PROTAGONISTA", "source":5, "target":7}, {"type":"DIRECTOR", "source":5, "target":7}, {"type":"PROTAGONISTA", "source":7, "target":1}, {"type":"DIRECTOR", "source":7, "target":1}, {"type":"PROTAGONISTA", "source":7, "target":2}, {"type":"DIRECTOR", "source":7, "target":2}, {"type":"PROTAGONISTA", "source":7, "target":5}, {"type":"DIRECTOR", "source":7, "target":5}]  };
    var edges = [];

    var result = $.grep(graph.nodes, function(e) {
      return e.color === "rgb(179, 65, 49)";
    });
    graph.nodes.forEach(function(e1) {
      if (e1.color === "rgb(236, 173, 50)") {
        graph.links.push({
          source: result[0].id,
          target: e1.id,
          type: null
        });
      }
    });
    graph.links.forEach(function(e) {
      var sourceNode = graph.nodes.filter(function(n) {
          return n.id === e.source;
        })[0],
        targetNode = graph.nodes.filter(function(n) {
          return n.id === e.target;
        })[0];
      edges.push({
        source: sourceNode,
        target: targetNode,
        value: e.type
      });
    });


    function getRandomInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1) + min);
    }

    var force = d3.layout.force()
      .size([1000, 1000])
      .charge(-400)
      .linkDistance(function(d) {
        if (d.source.color === "rgb(179, 65, 49)")
          return getRandomInt(200,400);
        return getRandomInt(600,800);
      })
      .linkStrength(function(d){
        if (d.source.color === "rgb(179, 65, 49)")
          return 0.8;
          return 0.2;
      })
      .on("tick", tick);

    var drag = force.drag()
      .on("dragstart", dragstart)
      .on("dragend", dragended);

    var svg = d3.select("#graph").append("svg")
      .attr("width", "100%").attr("height", "100%")
      .attr("pointer-events", "all");

    var link = svg.selectAll(".link"),
      node = svg.selectAll(".node");


    var defs = svg.append("defs");
    var filter = defs.append("filter")
      .attr("id", "drop-shadow")
      .attr("height", "130%");

    // SourceAlpha refers to opacity of graphic that this filter will be applied to
    // convolve that with a Gaussian with standard deviation 3 and store result
    // in blur
    filter.append("feGaussianBlur")
      .attr("in", "SourceAlpha")
      .attr("stdDeviation", 5)
      .attr("result", "blur");

    // translate output of Gaussian blur to the right and downwards with 2px
    // store result in offsetBlur
    filter.append("feOffset")
      .attr("in", "blur")
      .attr("dx", 2)
      .attr("dy", 2)
      .attr("result", "offsetBlur");

    // overlay original SourceGraphic over translated blurred opacity by using
    // feMerge filter. Order of specifying inputs is important!
    var feMerge = filter.append("feMerge");

    feMerge.append("feMergeNode")
      .attr("in", "offsetBlur")
    feMerge.append("feMergeNode")
      .attr("in", "SourceGraphic");

    force
      .nodes(graph.nodes)
      .links(edges)
      .start();

    link = link.data(edges)
      .enter().append("line")
      .attr("class", "link")
      .style("stroke", function(d) {
        switch (d.value) {
          case "DIRECTOR":
            return "rgb(114, 173, 184)";
            break;
          case "PROTAGONISTA":
            return "rgb(211, 219, 111)";
            break;
          default:
            return "rgb(150, 150, 150)";
            break;
        }
      });


    node = node.data(graph.nodes)
      .enter().append("g")
      .attr("class", "node")
      .on("dblclick", dblclick)
      .attr("ng-click", function(d) {
        return "updateFromGraph(" + d.id + ")"
      })
      .call(drag);
    node.append("svg:rect")
      .attr("width", function(d) {
        return d.nombre.length * 5 + 60
      })
      .attr("x", "-20px")
      .attr("y", "-23px")
      .style("filter", "url(#drop-shadow)")
      .attr("height", "45px")
      .style("fill", function(d) {
        return d.color ? d.color : "rgb(27, 172, 159)"
      });

    node.append("svg:image")
      .attr("class", "circle")
      .attr("xlink:href", function(d) {
        return d.imagen
      })
      .attr("x", "-18px")
      .attr("y", "-18px")
      .attr("width", "36px")
      .attr("height", "36px");

    node.append("text")
      .attr("dx", 18)
      .attr("dy", ".25em")
      .style("fill", "rgb(247, 247, 247)")
      .text(function(d) {
        return d.nombre
      });

    function tick() {
      link.attr("x1", function(d) {
          return d.source.x;
        })
        .attr("y1", function(d) {
          return d.source.y;
        })
        .attr("x2", function(d) {
          return d.target.x;
        })
        .attr("y2", function(d) {
          return d.target.y;
        });


      node.attr("transform", function(d) {
        return "translate(" + d.x + "," + d.y + ")";
      });

    }

    resize();
    d3.select(window).on("resize", resize);

    function resize() {
      width = window.innerWidth, height = window.innerHeight;
      svg.attr("width", width).attr("height", height);
      force.size([width + 30, height]).resume();
    }

    function dblclick(d) {
      d3.select(this).classed("fixed", d.fixed = false);

    }

    function dragstart(d) {
      d3.select(this).classed("fixed", d.fixed = true);
    }

    function dragended(d) {
      $('#close').click();
    }
    var app = angular.module('proyecto-y', []).config(function($sceProvider) {
      $sceProvider.enabled(false);
    });

    app.controller('mainController', function($scope) {
      $scope.resultados = graph.nodes;
      $scope.update = function(pelicula) {
        $scope.peliculaActiva = pelicula;
        $("html, body").animate({
          scrollTop: "0px"
        });
      };
      $scope.updateFromGraph = function(id) {
        indexRes = $scope.resultados.map(function(pelicula) {
          return pelicula.id;
        }).indexOf(id);
        $scope.peliculaActiva = $scope.resultados[indexRes];
        $("html, body").animate({
          scrollTop: "0px"
        });
      }

      $scope.showGraph = function() {
        $("html, body").animate({
          scrollTop: $(document).height()
        }, 1000);
      }
      $scope.cleanActive = function() {
        $scope.peliculaActiva = null;
      }
    });
  </script>
</body>

</html>
